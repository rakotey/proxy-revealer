############################################################## 
## MOD Title: Proxy Revealer Olympus 0.2.0 to 0.3.0
## MOD Author: jasmineaura < jasmine.aura@yahoo.com > (Jasmine Hasan) http://code.google.com/p/proxy-revealer/
## MOD Author: TerraFrost < terrafrost@phpbb.com > (Jim Wigginton) http://www.frostjedi.com/terra/wordpress/
## MOD Description: Attempts to determine someone's "real" IP address, using a myriad of techniques, and "blocks" such people.
## MOD Version: 0.3.0
##
## Installation Level: Intermediate
## Installation Time: 30 Minutes
##
## Files To Edit: 6
##      includes/constants.php
##      includes/session.php
##      includes/functions.php
##      language/en/acp/common.php
##      language/en/common.php
##      styles/prosilver/template/overall_header.html
##
## Included Files: 31
##      root/HttpRequestor.class
##      root/HttpRequestor.swf
##      root/expressInstall.swf
##      root/probe.php
##      root/swfobject.js
##      root/xss.xml
##      root/adm/style/acp_proxy_revealer.html
##      root/adm/style/acp_proxy_revealer_excludes.html
##      root/adm/style/acp_proxy_revealer_plugin.html
##      root/adm/style/acp_proxy_revealer_settings.html
##      root/includes/acp/acp_proxy_revealer.php
##      root/includes/info/acp_proxy_revealer.php
##		root/install/functions_install.php
##		root/install/index.php
##		root/install/schemas/firebird_schema.sql
##		root/install/schemas/mssql_schema.sql
##		root/install/schemas/mysql_40_schema.sql
##		root/install/schemas/mysql_41_schema.sql
##		root/install/schemas/oracle_schema.sql
##		root/install/schemas/postgres_schema.sql
##		root/install/schemas/sqlite_schema.sql
##		root/install/style/install_error.html
##		root/install/style/install_footer.html
##		root/install/style/install_header.html
##		root/install/style/install_main.html
##      root/language/en/mods/info_acp_proxy_revealer.php
##      root/language/en/mods/proxy_revealer_install.php
##      root/language/en/mods/proxy_revealer.php
##      root/styles/prosilver/template/pageloader.js
##      root/styles/prosilver/theme/pageloader.css
##      root/styles/prosilver/theme/images/loading.gif
##
## License: http://opensource.org/licenses/gpl-license.php GNU General Public License v2
##############################################################
## For security purposes, please check: http://www.phpbb.com/mods/
## for the latest version of this MOD. Although MODs are checked
## before being allowed in the MODs Database there is no guarantee
## that there are no security problems within the MOD. No support
## will be given for MODs not found within the MODs Database which
## can be found at http://www.phpbb.com/mods/
##############################################################
## Author Notes:
##
##############################################################
##############################################################
## MOD History:
##
##   2008-09-21 - Version 0.2.0
##      - See install.xml in the root of the archive, or install.txt in the contrib/ directory.
##
##############################################################

#
#-----[ COPY ]------------------------------------------
#
copy root/HttpRequestor.class to HttpRequestor.class
copy root/HttpRequestor.swf to HttpRequestor.swf
copy root/expressInstall.swf to expressInstall.swf
copy root/probe.php to probe.php
copy root/swfobject.js to swfobject.js
copy root/xss.xml to xss.xml
copy root/adm/style/acp_proxy_revealer.html to adm/style/acp_proxy_revealer.html
copy root/adm/style/acp_proxy_revealer_excludes.html to adm/style/acp_proxy_revealer_excludes.html
copy root/adm/style/acp_proxy_revealer_plugin.html to adm/style/acp_proxy_revealer_plugin.html
copy root/adm/style/acp_proxy_revealer_settings.html to adm/style/acp_proxy_revealer_settings.html
copy root/includes/acp/acp_proxy_revealer.php to includes/acp/acp_proxy_revealer.php
copy root/includes/info/acp_proxy_revealer.php to includes/info/acp_proxy_revealer.php
copy root/install/functions_install.php to install/functions_install.php
copy root/install/index.php to install/index.php
copy root/install/schemas/firebird_schema.sql to install/schemas/firebird_schema.sql
copy root/install/schemas/mssql_schema.sql to install/schemas/mssql_schema.sql
copy root/install/schemas/mysql_40_schema.sql to install/schemas/mysql_40_schema.sql
copy root/install/schemas/mysql_41_schema.sql to install/schemas/mysql_41_schema.sql
copy root/install/schemas/oracle_schema.sql to install/schemas/oracle_schema.sql
copy root/install/schemas/postgres_schema.sql to install/schemas/postgres_schema.sql
copy root/install/schemas/sqlite_schema.sql to install/schemas/sqlite_schema.sql
copy root/install/style/install_error.html to install/style/install_error.html
copy root/install/style/install_footer.html to install/style/install_footer.html
copy root/install/style/install_header.html to install/style/install_header.html
copy root/install/style/install_main.html to install/style/install_main.html
copy root/language/en/mods/proxy_revealer.php to language/en/mods/proxy_revealer.php
copy root/styles/prosilver/template/pageloader.js to styles/prosilver/template/pageloader.js
copy root/styles/prosilver/theme/pageloader.css to styles/prosilver/theme/pageloader.css
copy root/styles/prosilver/theme/images/loading.gif to styles/prosilver/theme/images/loading.gif
#
#-----[ OPEN ]------------------------------------------
#
includes/constants.php
#
#-----[ FIND ]------------------------------------------
#
define('COOKIE',16);
#
#-----[ AFTER, ADD ]------------------------------------
#
define('TOR_IPS',32);
#
#-----[ OPEN ]------------------------------------------
#
includes/session.php
#
#-----[ FIND ]------------------------------------------
#
		// START Proxy Revealer Olympus
		// $this->data['session_speculative_test'] can be thought of as a combination of three bits.  the bits that are set
		// represent the modes that tested positive for ip masking.  we compare that against the "blocking modes" by means
		// of a 'bitwise and' and from there, block as appropriate.
		if ( (int) $this->data['session_speculative_test'] > 0 && ((int) $this->data['session_speculative_test'] & (int) $config['ip_block']) )
		{
			header('HTTP/1.1 503 Service Unavailable');
			trigger_error('IP_MASK_BLOCKED');
		}
		// END Proxy Revealer Olympus
#
#-----[ REPLACE WITH ]------------------------------------------
#

#
#-----[ OPEN ]------------------------------------------
#
includes/functions.php
#
#-----[ FIND ]------------------------------------------
#
	// START Proxy Revealer Olympus
	if ((!empty($user->session_id) && !isset($user->data['session_speculative_test'])) || (int) $user->data['session_speculative_test'] < 0)
	{
		$sql = "SELECT ip_address 
			FROM " . SPECULATIVE_EXCLUDE_TABLE;
		$result = $db->sql_query($sql);

		// By default, we run speculative test, unless we find the user's IP is excluded from scanning
		$speculative_test = true;

		while ($row = $db->sql_fetchrow($result))
		{
			// Adapted from function check_ban() in session.php
			if (preg_match('#^' . str_replace('\*', '.*?', preg_quote($row['ip_address'], '#')) . '$#i', $user->ip))
			{
				$speculative_test = false;
				break;
			}
		}
		$db->sql_freeresult($result);
	
		// Should we require javascript?
		$javascript_required = ($config['require_javascript']) ? true : false;

		$user->data['session_speculative_key'] = strtolower(gen_rand_string(10));
	
		$sql = "UPDATE ".SESSIONS_TABLE." 
			SET session_speculative_test = 0, session_speculative_key = '{$user->data['session_speculative_key']}' 
			WHERE session_id = '{$user->data['session_id']}'";
		$db->sql_query($sql);
	
		if ( !empty($config['ip_prune']) )
		{
			$sql = "DELETE FROM ".SPECULATIVE_TABLE." 
				WHERE discovered < ".(time() - 86400 * $config['ip_prune']);
			$db->sql_query($sql);
		}
	}
	// END Proxy Revealer Olympus
#
#-----[ REPLACE WITH ]------------------------------------------
#

#
#-----[ FIND ]------------------------------------------
#
	// START Proxy Revealer Olympus
	$config['server_port'] = trim($config['server_port']);
	$server_name = trim($config['server_name']);
	$server_protocol = ($config['cookie_secure']) ? 'https://' : 'http://';
	$server_port = ($config['server_port'] != 80) ? ':' . $config['server_port'] : '';
	$path_name = '/' . preg_replace('/^\/?(.*?)\/?$/', '\1', trim($config['script_path']));
	$path_name.= ($path_name != '') ? '/' : '';
	$server_url = $server_protocol . $server_name . $server_port . $path_name;
	$speculative_key = $user->data['session_speculative_key'];
	// END Proxy Revealer Olympus
#
#-----[ REPLACE WITH ]------------------------------------------
#

#
#-----[ FIND ]------------------------------------------
#
		// START Proxy Revealer Olympus
		'L_REQUIRE_JS'					=> $user->lang['REQUIRE_JAVASCRIPT'],
		'S_REQUIRE_JS'					=> (isset($javascript_required)) ? $javascript_required : false,
		'U_REPROBE'						=> $server_url."probe.$phpEx?mode=reprobe&amp;extra={$user->session_id},$speculative_key",
		'L_PAGE_LOADING'				=> $user->lang['PAGE_LOADING_WAIT'],
		'S_SPECULATIVE_TEST'			=> (isset($speculative_test)) ? $speculative_test : false,
		// add a hidden iframe from which we'll include other iframe's.  call it iframe1 and the iframe's within it 
		// iframe2 and iframe3.  iframe2 and iframe3 add the IP address that was used to request them to the URL of yet 
		// another iframe - iframe4.
		'U_PROBE'						=> $server_url."probe.$phpEx?extra={$user->session_id},$speculative_key",
		// say a CGI proxy didn't convert over the URLs of an iframe.  that means that the IP address iframe2 and iframe3 add
		// is going to be the "real" IP address whereas normally it'd be the "masked" IP address.  to remedy that, we make a
		// seperate request to iframe4 via an iframe we'll call iframe0 and add the IP address to that.  that way, even if 
		// iframe2 and iframe3 pass on the "real" IP address to iframe4, iframe0 can still pass on the "masked" IP address.
		'U_PROBE_XSS'					=> $server_url."probe.$phpEx?mode=xss&amp;ip={$user->ip}&amp;extra={$user->session_id},$speculative_key",
		'U_PROBE_XSS2'					=> $server_url."probe.$phpEx?mode=xss&ip={$user->ip}&extra={$user->session_id},$speculative_key",
		// -moz-binding only works on FireFox.  we'd have done this in probe.php were it not for the fact that expressions
		// (only work in IE; they use U_PROBE_XSS and are used in the same style attribute where -moz-binding is used) don't
		// seem to work in small iframe's.
		'U_MOZ_BINDING'					=> $server_url . 'xss.xml#xss',
		// END Proxy Revealer Olympus
#
#-----[ REPLACE WITH ]------------------------------------------
#

#
#-----[ OPEN ]------------------------------------------
#
language/en/acp/common.php
#
#-----[ FIND ]------------------------------------------
#
// Proxy Revealer Olympus
$lang = array_merge($lang, array(
	'ACP_PROXY_REVEALER'				=> 'Proxy Revealer Olympus',
	'ACP_PROXY_REVEALER_EXTERNAL'		=> 'External IPs',
	'ACP_PROXY_REVEALER_INTERNAL'		=> 'Internal IPs',
	'ACP_PROXY_REVEALER_SETTINGS'		=> 'Settings',
	'ACP_PROXY_REVEALER_EXCLUDES'		=> 'Exceptions',
	'LOG_PROXY_REVEALER_SETTINGS'		=> '<strong>Altered Proxy Revealer settings</strong>',
	'LOG_PROXY_REVEALER_EXCLUDES_ADD'	=> '<strong>Excluded IP from Proxy Revealer scanning</strong><br />» %1$s',
	'LOG_PROXY_REVEALER_EXCLUDES_DEL'	=> '<strong>Removed IP from Proxy Revealer exceptions list</strong><br />» %s',
));
#
#-----[ REPLACE WITH ]------------------------------------------
#

#
#-----[ OPEN ]------------------------------------------
#
styles/prosilver/template/overall_header.html
#
#-----[ FIND ]------------------------------------------
#
<!-- IF S_SPECULATIVE_TEST -->
<link href="{T_THEME_PATH}/pageloader.css" rel="stylesheet" type="text/css">
#
#-----[ REPLACE WITH ]------------------------------------------
#
<!-- IF S_SPECULATIVE_TEST and not S_IS_BOT -->
<link href="{T_THEME_PATH}/pageloader.css" rel="stylesheet" type="text/css">
#
#-----[ FIND ]------------------------------------------
#
<!-- IF S_REQUIRE_JS -->
#
#-----[ REPLACE WITH ]------------------------------------------
#
<!-- IF S_REQUIRE_JS and not S_IS_BOT -->
#
#-----[ FIND ]------------------------------------------
#
<!-- IF S_SPECULATIVE_TEST -->
#
#-----[ REPLACE WITH ]------------------------------------------
#
<!-- IF S_SPECULATIVE_TEST and not S_IS_BOT -->
#
#-----[ FIND ]------------------------------------------
#
<div id="flashPopup" style="position:absolute;width:320px;height:180px;display:none;background:#ddd;border:1px solid #000;align:center"></div>
#
#-----[ REPLACE WITH ]------------------------------------------
#
<div id="flashPopup" style="z-index:99;position:absolute;width:320px;height:180px;display:none;background:#ddd;border:1px solid #000;align:center"></div>
#
#-----[ FIND ]------------------------------------------
#
<iframe src="{U_PROBE}" width="1" height="1" frameborder="0" id="iframe1"></iframe>
#
#-----[ BEFORE, ADD ]------------------------------------
#

<iframe src="{U_PROBE_MISC}" width="1" height="1" frameborder="0" id="misc_iframe"></iframe>
<!-- IF S_XSS_TEST -->
#
#-----[ FIND ]------------------------------------------
#
</script>
<![endif]-->
<!-- ENDIF -->
#
#-----[ AFTER, ADD ]------------------------------------
#
<!-- ENDIF -->
#
#-----[ DIY INSTRUCTIONS ]------------------------------
#

1. Login to the ACP after uploading included files and applying modifications as described above.
2. Point your browser to http://yoursite.com/forum-path/install/
3. Click Update and delete the install directory when you're finished.
4. Open the install.xml file in the root directory of this archive, then apply the modifications 
   to includes/functions.php and includes/session.php as described there.

#
#-----[ SAVE/CLOSE ALL FILES ]--------------------------
#
# EoM